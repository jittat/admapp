<div class="form-group border p-2" id="lastYearImportFormGroupId">
  <label for="import-form">
    นำเข้าเกณฑ์จากการรับเข้าจากปีการศึกษาที่แล้ว
    <button class="btn btn-outline-secondary btn-sm" id="importFormToggleId">เลือกเกณฑ์และนำเข้า</button>
  </label>
  <span class="text-muted"> กำหนดสาขาในตารางด้านบนก่อน เพื่อค้นเกณฑ์ที่เกี่ยวข้องกับสาขาดังกล่าวจากปีที่ผ่านมา</span>
  <div id="lastYearImportFormId"></div>
</div>
<script>
  var facultyId = "{{ faculty.id }}";
  function getMajorFieldValues(name_suffix) {
    var c = 1;
    var vals = [];
    while(true) {
      var inputName = 'majors_' + c + name_suffix;
      var input = $("[name='" + inputName + "']");
      if(input.length != 0) {
        vals.push(input.val());
      } else {
        break;
      }
      c++;
    }
    return vals.join(',');
  }
  function getMajorIds() {
    return getMajorFieldValues('_id');
  }
  function getMajorSlots() {
    return getMajorFieldValues('_slot');
  }
  function addSelectedMajorToImportLinks() {
    var majorIds = getMajorIds();
    if(majorIds == '') {
      return;
    }
    var additionalQueryStr = "&selected_major_id=" + majorIds + "&slots=" + getMajorSlots();
    $("#importCriteriaSearchResultsTableId a").each(function() {
      var href = $(this).attr("href");
      $(this).attr("href", href + additionalQueryStr);
    });
  }
  $(function(){
    // move import section to be before the criteria
    var targetDiv = $("#add-criterion-form .form-group").eq(1);
    $("#lastYearImportFormGroupId").insertBefore(targetDiv);

    $(document).on("click", "#importFormToggleId", function(){
      var majorIds = getMajorIds();
      if(majorIds == '') {
        alert('กรุณาเลือกสาขาก่อน จึงจะสามารถค้นเงื่อนไขการรับจากปีก่อนได้');
      }
      var url = "{% url 'backoffice:criteria:import-search' project.id admission_round.id %}?faculty_id=" + facultyId + "&majors=" + majorIds;
      $.get(url, function(data) {
        $("#lastYearImportFormId").html(data);
        $(".admission-criteria-edit-link-tds").hide();
        addSelectedMajorToImportLinks();
      });
      return false;
    });
  });
</script>
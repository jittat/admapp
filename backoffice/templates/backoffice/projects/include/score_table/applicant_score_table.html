{% load score_extras %}
<table class="table table-sm table-striped applicant-score-tables">
  <thead class="thead-inverse">
    <tr>
      <th></th>
      <th>เลขประจำตัว</th>
      {% if project.cross_majors_acceptance_visible %}
        <th></th>
      {% endif %}
      {% if not project.applicant_details_hidden %}
        <th>ชื่อ-นามสกุล</th>
        <th>แผนการเรียน</th>
      {% endif %}
      <th>GPAX</th>
      {% include "backoffice/projects/include/score_table/onet_header.html" %}
      {% include "backoffice/projects/include/score_table/gatpat_header.html" %}
      {% include "backoffice/projects/include/score_table/udat_header.html" %}
      {% comment %}
      {% include "backoffice/projects/include/score_table/additional_hack_header.html" %}
      {% endcomment %}
      {% if applicant_score_viewable %}
        <th>คะแนน</th>
        <th>เรียก<br />สัมภาษณ์</th>
      {% else %}
        <th></th>
        <th></th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
    {% for a in applicants %}
      <tr class="{% if a.is_called_for_interview %}app-interview-called{%else %}app-interview-not-called{% endif %}">
        <td class="ranks">{{ forloop.counter }}</td>
        <td class="national-ids">
          {{ a.national_id }}
        </td>
        {% if project.cross_majors_acceptance_visible %}
          <td>
            {% if a.other_major_info %}
              <span class="cross-{{ a.national_id }}">
                {% for m,s in a.other_major_info %}
                  <span data-appid="{{ a.national_id }}" data-mnum="{{ m }}" data-score="{{ s }}" class="major-markers major-marker-{{ m }}">&#8226;</span>
                {% endfor %}
              </span>
            {% endif %}
          </td>
        {% endif %}
        {% if not project.applicant_details_hidden %}
          <td>{{ a.get_full_name }}</td>
          <td>{{ a.educationalprofile.get_education_plan_display }}</td>
        {% endif %}
        <td>{{ a.educationalprofile.gpa|floatformat:"2" }}</td>
        {% with a as applicant %}
          <td class="onet-odd">{{ applicant.get_all_exam_scores.onet.x03|score }}</td>
          
          <td class="gatpat-odd">{{ applicant.get_all_exam_scores.gatpat_rounds|round_array }}</td>
          <td class="gatpat-even">{{ applicant.get_all_exam_scores.gatpat_array.gat|score_array }}</td>
          <td class="gatpat-odd">{{ applicant.get_all_exam_scores.gatpat_array.pat1|score_array }}</td>
          <td class="gatpat-even">{{ applicant.get_all_exam_scores.gatpat_array.pat2|score_array }}</td>
          <td class="gatpat-odd">{{ applicant.get_all_exam_scores.gatpat_array.pat3|score_array }}</td>
          <td class="gatpat-even">{{ applicant.get_all_exam_scores.gatpat_array.pat4|score_array }}</td>
          <td class="gatpat-odd">{{ applicant.get_all_exam_scores.gatpat_array.pat5|score_array }}</td>
          <td class="gatpat-odd">{{ applicant.get_all_exam_scores.gatpat_array.pat7|round_array }}</td>

          <td class="udat-even">{{ applicant.get_all_exam_scores.udat.u09|score }}</td>
          <td class="udat-odd">{{ applicant.get_all_exam_scores.udat.u19|score }}</td>
          <td class="udat-even">{{ applicant.get_all_exam_scores.udat.u29|score }}</td>
          <td class="udat-odd">{{ applicant.get_all_exam_scores.udat.u39|score }}</td>
          <td class="udat-even">{{ applicant.get_all_exam_scores.udat.u49|score }}</td>
          <td class="udat-odd">{{ applicant.get_all_exam_scores.udat.u59|score }}</td>
          <td class="udat-even">{{ applicant.get_all_exam_scores.udat.u69|score }}</td>

          {% comment %}
            {% include "backoffice/projects/include/score_table/onet_cells.html" %}
            {% include "backoffice/projects/include/score_table/gatpat_cells.html" %}
            {% include "backoffice/projects/include/score_table/udat_cells.html" %}
          {% endcomment %}
          {% comment %}
          {% include "backoffice/projects/include/score_table/additional_hack_cells.html" %}
          {% endcomment %}
        {% endwith %}
        {% if not a.is_criteria_passed %}
          <td><i class="fa fa-times" style="color: red;"></i> ไม่ผ่านเกณฑ์</td>
          <td></td>
        {% else %}
          {% if applicant_score_viewable %}
            <td class="scores">
              {% if a.admission_result.scoring_criteria_passed %}
                {{ a.admission_result.calculated_score_display }}
              {% else %}
                <i class="fa fa-times" style="color: red;"></i> {{ a.admission_result.criteria_failed_display }}
              {% endif %}
            </td>
            <td class="chboxes">
              {% if a.is_interview_callable %}
                {% if accepted_for_interview_result_frozen %}
                  {% if a.is_called_for_interview %}<i class="fa fa-check" style="color: green;"></i>{% else %}<i class="fa fa-times" style="color: red;"></i>{% endif %}
                {% else %}
                  <input class="call-checkboxes" id="applicant_call_{{ a.national_id }}" data-natid="{{ a.national_id }}" type="checkbox" {% if a.is_called_for_interview %}checked{% endif %} />
                {% endif %}
              {% endif %}
            </td>
          {% else %}
            <td class="scores"></td>
            <td class="chboxes"></td>
          {% endif %}
        {% endif %}
      </tr>
    {% endfor %}
  </tbody>
</table>
<script>
  var minMajorScore = {
    {% for num, score in cross_major_scores.items %}{{ num }}: {{ score }}{% if not forloop.last %}, {% endif %}{% endfor %}
  };
  
  var updateCall = function(count) {
    $('.call-checkboxes').each(function(i, elt) {
      if(i < count) {
        $(elt).prop('checked', true);
      } else {
        $(elt).prop('checked', false);
      }
      
      var row = $(elt).parents('tr').first();
      if($(elt).prop('checked')) {
        $(row).addClass('app-interview-called');
        $(row).removeClass('app-interview-not-called');
      } else {
        $(row).addClass('app-interview-not-called');
        $(row).removeClass('app-interview-called');
      }
    });
  };

  var updateMajorMarkers = function() {
    $('.major-markers').each(function(idx) {
      var elt = $(this);
      var mnum = $(this).data('mnum');
      var score = $(this).data('score');
      if(minMajorScore[mnum] < score) {
        elt.addClass('accepted');
        elt.html('*');
      } else {
        elt.removeClass('accepted');
        elt.html('&#8226;');
      }
    });
  };
  
  $(function(){
    var url = '{% url 'backoffice:projects-interview-call-score-update' project.id admission_round.id major.number %}';
    $('.call-checkboxes').click(function(){
      var status = $(this).prop('checked') ? 'selected' : 'not-selected';
      var nationalId = $(this).data('natid');

      $('#data_load_notice_id').html('<span style="color: red;">กำลังจัดเก็บข้อมูล...</span>').show();
      jQuery.post(url, {
        nationalId: nationalId,
        status: status,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      }, function(data) {
        updateCall(data);
        $('.interview-count-spans').text(data);
        $('#data_load_notice_id').html('<span style="color: green;">จัดเก็บข้อมูลเสร็จแล้ว</span>').delay(3000).fadeOut();
      });
    });

    updateMajorMarkers();
  });
</script>

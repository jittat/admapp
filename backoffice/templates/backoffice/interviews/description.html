{% extends 'backoffice/base.html' %}
{% block content %}
<div class="row">
    <div class="col-md-12">

        <h2>
            ข้อมูลการสัมภาษณ์ {{ admission_round}} {{ faculty }}
        </h2>

        <form method="post" id="form"
              enctype="multipart/form-data">
            <h3>
                เลือกโครงการ
            </h3>
            {% include "backoffice/interviews/curriculum_major_table_form.html" %}

            <h4>ข้อมูลทั่วไป</h4>
            <div class="form-row">
                <div class="col-md-3">
                    <label for="{{ form.interview_type.id_for_label }}">รูปแบบการสัมภาษณ์</label>
                </div>
                <div class="col-md-9">
                    {{ form.interview_options.errors }}
                    {{ form.interview_options }}
                </div>
            </div>
            <div class="form-row mt-2">
                <div class="col-md-3">
                    <label for="{{form.additional_doc.id_for_label}}">การส่งเอกสารเพิ่มเติม</label>
                </div>
                <div class="col-md-9">
                    {{form.is_additional_documents_required.errors}}
                    {{form.is_additional_documents_required}}
                </div>
            </div>
            <div class="form-row mt-2 form-group">
                <div class="col-md-3">
                    <label for="{{form.datetime.id_for_label}}">วันเวลา</label>
                </div>
                <div class="col-md-9">
                    {{form.interview_date.errors}}
                    {{form.interview_date}}
                </div>
            </div>

            <h4 class="mt-3">การเตรียมตัวก่อนสัมภาษณ์</h4>
            <div class="form-row">
                <div class="col-md-12">
                    <label for="{{form.prep_detail.id_for_label}}">รายละเอียดการเตรียมตัว</label>
                    {{form.preparation_descriptions.errors}}
                    {{form.preparation_descriptions}}
                </div>
            </div>
            <div class="form-row mt-2">
                <div class="col-md-3 pr-2">
                    รูปประกอบ
                    <small class="text-muted">รูปจะปรากฏด้านขวาของข้อความ</small>
                    <br>
                    <img width="250px" class="img-fluid" id="prepImgId" alt="preparation"
                         {% if form.instance.preparation_image %}
                         src="{% url 'backoffice:interviews-image' admission_round_id=admission_round.id faculty_id=faculty.id description_id=interview_description_id type='preparation' %}"
                         {% endif %}>
                </div>
                <div class="col-md-9">
                    <div class="custom-file">
                        {{form.preparation_image.errors}}
                        {{form.preparation_image}}
                        <label class="custom-file-label" for="{{form.prep_img.id_for_label}}">Choose file</label>
                    </div>
                </div>
            </div>


            <h4 class="mt-3">รายละเอียดการสัมภาษณ์ออนไลน์</h4>
            <div class="form-row">
                <div class="col-md-3">
                    สัมภาษณ์ผ่านทางโปรแกรม
                </div>
                <div class="col-md-9">
                    {% for radio in form.video_conference_platform %}
                    <div class="form-check form-check-inline">
                        {{ radio }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="form-row">
                <div class="col-md-12">
                    {{form.descriptions.label}}
                    <small class="text-muted">{{form.descriptions.help_text}}</small>
                    {{form.descriptions.errors}}
                    {{form.descriptions}}
                </div>
            </div>
            <div class="form-row mt-2">
                <div class="col-md-3">
                    {{form.description_image.label}}
                    <small class="text-muted">{{form.description_image.help_text}}</small>
                    <br>
                    <img width="250px" class="img-fluid" id="descImgId" alt="interview details"
                         {% if form.instance.description_image %}
                         src="{% url 'backoffice:interviews-image' admission_round_id=admission_round.id faculty_id=faculty.id description_id=interview_description_id type='description' %}"
                         {% endif %}>
                </div>
                <div class="col-md-9">
                    <div class="custom-file">
                        {{form.description_image.errors}}

                        <label class="custom-file-label" for="{{form.interview_img.id_for_label}}">Choose file</label>
                    </div>
                </div>
            </div>
            <h4 class="mt-3">ข้อมูลการติดต่อ</h4>
            <div id="contact-person-root">
            </div>
            <div class="form-row mt-2">
                <div class="col-md-12">
                    <button class="btn btn-secondary" type="button" id="add-contact-person">เพิ่มผู้ติดต่อ</button>
                </div>
            </div>

            <div class="form-row bg-light mt-2 p-2 rounded">
                <div class="col">
                    <button class="btn btn-outline-primary" id="preview-button" type="button" onclick="previewForm()">
                        ดูตัวอย่าง
                    </button>
                    <button class="btn btn-success">จัดเก็บ</button>
                    <button class="btn btn-warning">ยกเลิกการแก้ไข</button>
                    <button class="btn btn-danger ml-2">ลบ</button>
                </div>
            </div>
            {{form.contacts.errors}}
            {{form.contacts}}
            {% csrf_token %}
        </form>
        <!--        Preview -->
        <h3>
            โครงการ
        </h3>
        <ol id="preview-projects">
        </ol>

        <h4>ข้อมูลทั่วไป</h4>
        <div class="form-row">
            <div class="col-md-3">
                รูปแบบการสัมภาษณ์
            </div>
            <div class="col-md-9">
                {{ form.instance.get_interview_options_display }}
            </div>
        </div>
        <div class="form-row mt-2">
            <div class="col-md-3">
                <label for="{{form.additional_doc.id_for_label}}">การส่งเอกสารเพิ่มเติม</label>
            </div>
            <div class="col-md-9">
                {{form.instance.get_is_additional_documents_required_display}}
            </div>
        </div>
        <div class="form-row mt-2 form-group">
            <div class="col-md-3">
                <label for="{{form.datetime.id_for_label}}">วันเวลา</label>
            </div>
            <div class="col-md-9">
                {{form.interview_date.value}}
            </div>
        </div>

        <h4 class="mt-3">การเตรียมตัวก่อนสัมภาษณ์</h4>
        <div class="form-row">
            <div class="col-md-12">
                รายละเอียดการเตรียมตัว
                <p>{{form.preparation_descriptions.value}}</p>
            </div>
        </div>
        <div class="form-row mt-2">
            <div class="col-md-3 pr-2">
                {{form.preparation_image.label}}
                <br>
                {% if form.instance.preparation_image %}
                <img src="{% url 'backoffice:interviews-image' admission_round_id=admission_round.id faculty_id=faculty.id description_id=interview_description_id type='preparation' %}">
                {% endif %}
            </div>
        </div>


        <h4 class="mt-3">รายละเอียดการสัมภาษณ์ออนไลน์</h4>
        <div class="form-row">
            <div class="col-md-3">
                สัมภาษณ์ผ่านทางโปรแกรม
            </div>
            <div class="col-md-9">
                {% for radio in form.apptype %}
                <div class="form-check form-check-inline">
                    {{ radio }}
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="form-row mt-2">
            <div class="col-md-3">
                {{form.description_image.label}}
                <br>
                {% if form.instance.description_image %}
                <img src="{% url 'backoffice:interviews-image' admission_round_id=admission_round.id faculty_id=faculty.id description_id=interview_description_id type='description' %}">
                {% endif %}
            </div>
        </div>
        <div class="form-row">
            <div class="col-md-12">
                {{form.descriptions.label}}
                <p>
                    {{form.descriptions.value}}
                </p>
            </div>
        </div>
        <h4 class="mt-3">ข้อมูลการติดต่อ</h4>
        <div>
            <ol>
                {% for person in contacts %}
                <li class="person-preview">
                    <p>ชื่อ: {{ person.name }}&emsp;อีเมล: {{ person.email }}&emsp;เบอร์โทร: {{ person.tel }}</p>
                </li>
                {% endfor %}
            </ol>
        </div>

        <div style="display:none">
            <div class="contact-person-form">
                <div class="form-row">
                    <div class="col-md-4">ชื่อผู้ติดต่อ</div>
                    <div class="col-md-3">อีเมล</div>
                    <div class="col-md-3">โทรศัพท์</div>
                    <div class="col-md-2"></div>
                </div>
                <div class="form-row">
                    <div class="col-md-4">
                        <input type="text" name="name" class="form-control"></div>
                    <div class="col-md-3">
                        <input type="text" name="email" class="form-control"></div>
                    <div class="col-md-3">
                        <input type="text" name="tel" class="form-control"></div>
                    <div class="col-md-2">
                        <button class="btn-sm btn-danger delete-contact-person" type="button">ลบ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
  $(function () {
    $('.img-file-controls').change(function () {
      var imgId = $(this).data('imgId');
      var file = this.files[0];
      if (file) {
        var reader = new FileReader();
        reader.onload = function (event) {
          $('#' + imgId).attr('src', event.target.result);
        };
        reader.readAsDataURL(file);
      }
    });
  });

  let contactsInput = $('#{{form.contacts.id_for_label}}')
  var contacts = contactsInput[0].value === 'null' ? [{}] : JSON.parse(contactsInput[0].value);
  for (var i = 0; i < contacts.length; i++) {
    var contact = contacts[i];
    var contactForm = $('.contact-person-form').last().clone();
    contactForm.find('input[name="name"]').val(contact.name);
    contactForm.find('input[name="email"]').val(contact.email);
    contactForm.find('input[name="tel"]').val(contact.tel);
    if (i === 0) {
      contactForm.find('.delete-contact-person').remove()
    }
    $('#contact-person-root').append(contactForm);
  }

  $('#add-contact-person').on('click', function () {
    var contactForm = $('.contact-person-form').last().clone();
    contactForm.find('input[name="name"]').val('');
    contactForm.find('input[name="email"]').val('');
    contactForm.find('input[name="tel"]').val('');
    $('#contact-person-root').append(contactForm);
  });
  $(document).on('click', '.delete-contact-person', function () {
    $(this).closest('.contact-person-form').remove();
  });

  $('#form').on('submit', function () {
    console.log('before submit')
    const contacts = [];

    // loop through each contact person form and create an object for it
    const contactForms = $('.contact-person-form')
    for (let i = 0; i < contactForms.length - 1; i++) {
      const name = contactForms[i].querySelector('input[name="name"]').value;
      const tel = contactForms[i].querySelector('input[name="tel"]').value;
      const email = contactForms[i].querySelector('input[name="email"]').value;
      contacts.push({name, tel, email});
    }
    contactsInput.val(JSON.stringify(contacts))

    return true
  })


  function previewProjectMajors(formData) {
    const project_majors = formData.getAll('project_majors')
    $('#preview-projects').empty()
    for (let p of project_majors) {
      const title = $(`input[name='project_majors'][value='${p}']`).attr('title')
      $('#preview-projects').append('<li>' + title + '</li>');
    }
  }

  function previewForm() {
    let form = document.getElementById("form");
    const formData = new FormData(form);

    previewProjectMajors(formData);
  }

</script>
{% endblock %}
